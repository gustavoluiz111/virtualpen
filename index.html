<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caneta Virtual Gestual</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }

        .canvas-box {
            position: relative;
            width: 100%;
            max-width: 450px;
            aspect-ratio: 4/3;
            background: #111;
            overflow: hidden;
            border-radius: 16px;
            border: 4px solid #6366f1;
        }

        canvas, video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #drawCanvas {
            z-index: 10;
        }

        #videoCanvas {
            z-index: 5;
            transform: scaleX(-1);
        }
    </style>
</head>

<body class="bg-gray-900 text-white p-4 flex flex-col items-center gap-4">

    <h1 class="text-xl font-bold text-indigo-400">Caneta Virtual Gestual</h1>

    <button id="start" onclick="startCam()" class="bg-indigo-600 px-6 py-3 rounded-full text-white font-bold">
        Iniciar Câmera
    </button>

    <div class="flex gap-2 flex-wrap justify-center">
        <button onclick="setColor('255,0,0')" class="bg-red-600 px-3 py-2 rounded-lg">Vermelho</button>
        <button onclick="setColor('0,255,0')" class="bg-green-600 px-3 py-2 rounded-lg">Verde</button>
        <button onclick="setColor('0,0,255')" class="bg-blue-600 px-3 py-2 rounded-lg">Azul</button>
        <button onclick="clearDraw()" class="bg-gray-500 px-3 py-2 rounded-lg">Limpar</button>
        <button onclick="savePNG()" class="bg-yellow-500 px-3 py-2 rounded-lg">Salvar PNG</button>
    </div>

    <p id="status" class="text-sm text-indigo-300 font-semibold">
        Aguardando câmera...
    </p>

    <div class="canvas-box">
        <canvas id="videoCanvas"></canvas>
        <canvas id="drawCanvas"></canvas>
    </div>

    <script>
        const videoCanvas = document.getElementById("videoCanvas");
        const videoCtx = videoCanvas.getContext("2d");

        const drawCanvas = document.getElementById("drawCanvas");
        const drawCtx = drawCanvas.getContext("2d");

        let videoEl = document.createElement("video");
        let camera;

        let drawColor = "255,0,0";
        let thickness = 8;
        let eraserSize = 40;
        let prevX = null;
        let prevY = null;

        function fitCanvas() {
            const box = document.querySelector(".canvas-box");
            videoCanvas.width = box.clientWidth;
            videoCanvas.height = box.clientHeight;
            drawCanvas.width = box.clientWidth;
            drawCanvas.height = box.clientHeight;
        }

        window.onload = fitCanvas;
        window.onresize = fitCanvas;

        function setColor(c) {
            drawColor = c;
            document.getElementById("status").textContent = "Cor alterada";
        }

        function clearDraw() {
            drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
        }

        function savePNG() {
            const link = document.createElement("a");
            link.download = "desenho.png";
            link.href = drawCanvas.toDataURL("image/png");
            link.click();
        }

        function getGesture(landmarks) {
            const tip = [8, 12, 16, 20];
            const pip = [6, 10, 14, 18];
            let fingers = [];

            for (let i = 0; i < 4; i++) {
                fingers.push(landmarks[tip[i]].y < landmarks[pip[i]].y);
            }

            const allDown = fingers.every(f => !f);

            if (allDown) return "CLEAR";
            if (fingers[0] && fingers[1] && !fingers[2] && !fingers[3]) return "ERASE";
            if (fingers[0] && !fingers[1] && !fingers[2] && !fingers[3]) return "DRAW";

            return "IDLE";
        }

        function onResults(results) {
            videoCtx.save();
            videoCtx.clearRect(0, 0, videoCanvas.width, videoCanvas.height);
            videoCtx.scale(-1, 1);
            videoCtx.translate(-videoCanvas.width, 0);
            videoCtx.drawImage(results.image, 0, 0, videoCanvas.width, videoCanvas.height);
            videoCtx.restore();

            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                prevX = prevY = null;
                return;
            }

            const landmarks = results.multiHandLandmarks[0];

            drawConnectors(videoCtx, landmarks, HAND_CONNECTIONS, { color: "#00FF00", lineWidth: 2 });
            drawLandmarks(videoCtx, landmarks, { color: "#FF0000", lineWidth: 2 });

            const g = getGesture(landmarks);

            const tip = landmarks[8];
            const x = (1 - tip.x) * drawCanvas.width;
            const y = tip.y * drawCanvas.height;

            if (g === "CLEAR") {
                clearDraw();
                prevX = prevY = null;
                document.getElementById("status").textContent = "Limpou a tela";
                return;
            }

            if (g === "DRAW") {
                drawCtx.globalCompositeOperation = "source-over";
                drawCtx.strokeStyle = `rgb(${drawColor})`;
                drawCtx.lineWidth = thickness;
                drawCtx.lineCap = "round";

                if (prevX == null) {
                    prevX = x;
                    prevY = y;
                }

                drawCtx.beginPath();
                drawCtx.moveTo(prevX, prevY);
                drawCtx.lineTo(x, y);
                drawCtx.stroke();

                prevX = x;
                prevY = y;

                document.getElementById("status").textContent = "Desenhando";
            } 
            else if (g === "ERASE") {
                drawCtx.globalCompositeOperation = "destination-out";

                drawCtx.beginPath();
                drawCtx.arc(x, y, eraserSize, 0, 2 * Math.PI);
                drawCtx.fill();

                document.getElementById("status").textContent = "Apagando";
                prevX = prevY = null;
            }
            else {
                prevX = prevY = null;
                document.getElementById("status").textContent = "Idle";
            }
        }

        const hands = new Hands({
            locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 0,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.6
        });

        hands.onResults(onResults);

        async function startCam() {
            document.getElementById("start").textContent = "Carregando...";

            camera = new Camera(videoEl, {
                onFrame: async () => {
                    await hands.send({ image: videoEl });
                },
                width: 640,
                height: 480
            });

            await camera.start();

            document.getElementById("start").style.display = "none";
            document.getElementById("status").textContent = "Câmera iniciada";
        }
    </script>

</body>
</html>
